# ===================================================================
# R 회귀분석 코드 (performance 패키지 함수명 수정 버전)
# ===================================================================

# -------------------------------------------------------------------
# 0단계: 필요한 라이브러리 설치 및 로드
# -------------------------------------------------------------------
packages <- c("readxl", "corrplot", "performance", "lmtest", "stargazer")
new_packages <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)
lapply(packages, library, character.only = TRUE)

# -------------------------------------------------------------------
# 1단계: 변수 정의 (데이터 불러오기)
# -------------------------------------------------------------------
file_path <- "./Downloads/capston_cluster_analysis_data.xlsx"
df <- read_excel(file_path, sheet = "1번 최종 데이터") # 실제 시트 이름으로 변경

cat("--- 1. 데이터 확인 ---\n")
str(df)
head(df)

# -------------------------------------------------------------------
# 2단계: 데이터 전처리
# -------------------------------------------------------------------
cat("\n--- 2.1 결측치 확인 및 제거 ---\n")
print(colSums(is.na(df)))
df <- na.omit(df)

cat("\n--- 2.2 이상치 탐색 (Boxplot) ---\n")
par(mfrow = c(2, 2), mar = c(4, 4, 2, 1))
boxplot(df$방문객, main = "방문객")
boxplot(df$음식, main = "음식")
boxplot(df$`평균 체류시간`, main = "평균 체류시간")
boxplot(df$`평균 숙박일수`, main = "평균 숙박일수")
par(mfrow = c(1, 1))

# -------------------------------------------------------------------
# 3단계: 탐색적 데이터 분석 (EDA)
# -------------------------------------------------------------------
cat("\n--- 3.1 기술통계량 확인 ---\n")
summary(df)

cat("\n--- 3.2 변수 간 상관관계 분석 ---\n")
numeric_vars <- df[, sapply(df, is.numeric)]
cor_matrix <- cor(numeric_vars)
corrplot(cor_matrix, method = "color", type = "upper", order = "hclust",
         addCoef.col = "black", tl.col = "black", tl.srt = 45)

# -------------------------------------------------------------------
# 4단계 & 5단계: 모델 설정 및 추정
# -------------------------------------------------------------------
cat("\n--- 4 & 5. 초기 회귀모델 추정 결과 ---\n")
initial_model <- lm(방문객 ~ 음식 + 문화관광 + 숙박 + 쇼핑 + 기타관광 + 
                      역사관광 + 레저스포츠 + 체험관광 + `평균 체류시간` + `평균 숙박일수`, 
                    data = df)
print(summary(initial_model))

# -------------------------------------------------------------------
# 6단계: 가정 검토 (*** 여기가 핵심 변경 부분 ***)
# -------------------------------------------------------------------
cat("\n--- 6.1 회귀진단 그래프 ---\n")
par(mfrow = c(2, 2))
plot(initial_model)
par(mfrow = c(1, 1))

cat("\n--- 6.2 오차의 독립성 검정 (Durbin-Watson) ---\n")
print(lmtest::dwtest(initial_model))

cat("\n--- 6.3 다중공선성 검사 (VIF) ---\n")
# performance 패키지의 올바른 함수인 check_collinearity() 사용
print(performance::check_collinearity(initial_model))

# -------------------------------------------------------------------
# 7단계: 모델 진단 및 수정
# -------------------------------------------------------------------
cat("\n--- 7. 최종 모델 선택 (Stepwise Selection) ---\n")
final_model <- step(initial_model, direction = "backward", trace = 0)
cat("\n--- 최종 모델 요약 결과 ---\n")
print(summary(final_model))

cat("\n--- 최종 모델 다중공선성 재확인 (VIF) ---\n")
# 수정된 모델에서도 올바른 함수 사용
print(performance::check_collinearity(final_model))

# -------------------------------------------------------------------
# 8단계: 결과 해석
# -------------------------------------------------------------------
cat("\n--- 8. 결과 해석 ---\n")
cat("위 '수정된 최종 모델 요약 결과'를 해석합니다.\n")

# -------------------------------------------------------------------
# 9단계: 보고 및 활용
# -------------------------------------------------------------------
cat("\n--- 9. 회귀분석 결과표 생성 ---\n")
stargazer(initial_model, final_model, type = "text",
          title = "회귀분석 결과 비교",
          dep.var.labels = "방문객 수",
          covariate.labels = c("음식", "문화관광", "숙박", "쇼핑", "기타관광",
                               "역사관광", "레저스포츠", "체험관광", 
                               "평균 체류시간", "평균 숙박일수"),
          align = TRUE)